generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  schemas  = ["aura"]
}

model UserProfile {
  name                  String
  weight                Float?
  height                Float?
  activityLevel         String?
  workType              String?
  goals                 String[]
  dietaryRestrictions   String[]
  preferences           String[]
  allergies             String[]
  medicalConditions     String[]
  medications           String[]
  usualMealsPerDay      Int?
  wakeTime              String?
  sleepTime             String?
  timezone              String?
  caloricTarget         Int?
  proteinTarget         Int?
  carbTarget            Int?
  fatTarget             Int?
  assistantThreadId     String?
  lastCheckInAt         DateTime?
  lastWeighInAt         DateTime?
  notes                 String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  cpf                   String?           @unique
  isPaymentActive       Boolean           @default(false)
  lastPaymentAt         DateTime?
  nextBillingAt         DateTime?
  subscriptionExpiresAt DateTime?
  subscriptionPlan      SubscriptionPlan  @default(FREE)
  pendingPlan           SubscriptionPlan? // Plano agendado para pr√≥ximo ciclo (downgrades)

  // Asaas Subscription Fields
  asaasCustomerId     String? @unique
  asaasSubscriptionId String? @unique
  subscriptionStatus  String? // ACTIVE, INACTIVE, OVERDUE
  subscriptionCycle   String? // MONTHLY, YEARLY

  planStyle                    PlanStyle?
  requestsLastReset            DateTime?
  requestsToday                Int                  @default(0)
  passwordHash                 String?
  email                        String?
  address                      String               @default("")
  addressNumber                String?
  addressComplement            String?
  zipCode                      String               @default("")
  role                         Role                 @default(USER)
  waterReminderEnabled         Boolean              @default(false)
  waterReminderIntervalMinutes Int?
  waterReminderLastSent        DateTime?
  conversionAttempts           Int                  @default(0)
  lastConversionMessageAt      DateTime?
  id                           Int                  @id @unique @default(autoincrement())
  phoneNumber                  String               @unique
  isActive                     Boolean              @default(true)
  meals                        Meal[]
  payments                     Payment[]
  promptUsages                 PromptUsage[]
  userMetricLogs               UserMetricLog[]
  reactivationTokens           ReactivationToken[]
  passwordResetTokens          PasswordResetToken[]

  nextMorningGreetingAt   DateTime?
  nextWaterReminderAt     DateTime?
  nextConversionAttemptAt DateTime?

  @@index([nextMorningGreetingAt])
  @@index([nextWaterReminderAt])
  @@index([nextConversionAttemptAt])
  @@map("user_profile")
  @@schema("aura")
}

model Meal {
  id          Int         @id @default(autoincrement())
  content     String
  mealType    MealType
  timestamp   DateTime    @default(now())
  userId      Int
  userProfile UserProfile @relation(fields: [userId], references: [id])

  @@map("meal")
  @@schema("aura")
}

model UserMetricLog {
  id       Int         @id @default(autoincrement())
  loggedAt DateTime    @default(now())
  weight   Float?
  bodyFat  Float?
  waist    Float?
  hip      Float?
  userId   Int
  user     UserProfile @relation(fields: [userId], references: [id])

  @@map("user_metric_log")
  @@schema("aura")
}

model Payment {
  id                    Int              @id @default(autoincrement())
  amount                Float
  plan                  SubscriptionPlan
  status                String
  method                String?
  paidAt                DateTime?
  asaasPaymentId        String?          @unique
  bankSlipUrl           String?
  createdAt             DateTime         @default(now())
  dueDate               DateTime?
  invoiceUrl            String?
  pixPayload            String?
  pixQrCode             String?
  pixReminderLastSentAt DateTime?
  transactionReceiptUrl String?
  userId                Int
  user                  UserProfile      @relation(fields: [userId], references: [id])

  @@index([status, dueDate])
  @@map("payment")
  @@schema("aura")
}

model PromptUsage {
  id        Int         @id @default(autoincrement())
  date      DateTime
  count     Int         @default(0)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  userId    Int
  user      UserProfile @relation(fields: [userId], references: [id])

  @@unique([userId, date], name: "userId_date", map: "userId_date")
  @@map("prompt_usage")
  @@schema("aura")
}

model ReactivationToken {
  id        Int         @id @default(autoincrement())
  token     String      @unique
  userId    Int
  user      UserProfile @relation(fields: [userId], references: [id])
  expiresAt DateTime
  used      Boolean     @default(false)
  createdAt DateTime    @default(now())

  @@map("reactivation_token")
  @@schema("aura")
}

model PasswordResetToken {
  id        Int         @id @default(autoincrement())
  token     String      @unique
  userId    Int
  user      UserProfile @relation(fields: [userId], references: [id])
  expiresAt DateTime
  used      Boolean     @default(false)
  createdAt DateTime    @default(now())

  @@map("password_reset_token")
  @@schema("aura")
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK

  @@schema("aura")
}

enum PlanStyle {
  BALANCEADO
  LOW_CARB
  HIGH_PROTEIN
  VEGANO
  VEGETARIANO
  MEDITERRANEO

  @@schema("aura")
}

enum SubscriptionPlan {
  FREE
  PLUS
  PRO
  PLUS_ANUAL
  PRO_ANUAL

  @@schema("aura")
}

enum Role {
  USER
  ADMIN

  @@schema("aura")
}
